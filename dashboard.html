<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Личный кабинет</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 700px;
      margin: 20px auto;
      padding: 0 15px;
    }
    h1 {
      margin-bottom: 10px;
    }
    .course {
      margin-bottom: 25px;
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 6px;
      background: #f9f9f9;
    }
    .course h2 {
      margin-top: 0;
    }
    ul.lessons {
      padding-left: 20px;
    }
    ul.lessons li {
      margin: 5px 0;
      cursor: default;
    }
  </style>
</head>
<body>
  <h1>Личный кабинет</h1>
  <p id="welcome">Загрузка...</p>
  <button id="btnLogout">Выйти</button>

  <div id="coursesContainer"></div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js'

    const supabaseUrl = 'https://eawveeyhkqewfhswcxmy.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVhd3ZlZXloa3Fld2Zoc3djeG15Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NTI5MTYsImV4cCI6MjA2NjMyODkxNn0.-6G5o9dZ2V9cAfqIBIYzFp5PDzs4IehCn_b3YlYot-I'
    const supabase = createClient(supabaseUrl, supabaseKey)

    const welcome = document.getElementById('welcome')
    const btnLogout = document.getElementById('btnLogout')
    const coursesContainer = document.getElementById('coursesContainer')

    btnLogout.addEventListener('click', async () => {
      await supabase.auth.signOut()
      window.location.href = 'login.html'
    })

    async function loadDashboard() {
      const { data: { session } } = await supabase.auth.getSession()
      if (!session) {
        window.location.href = 'login.html'
        return
      }
      const user = session.user

      // Получаем имя пользователя из profiles
      const { data: profile } = await supabase
        .from('profiles')
        .select('name')
        .eq('id', user.id)
        .single()

      const userName = profile?.name || user.email
      welcome.textContent = `Добро пожаловать, ${userName}.`

      // Получаем курсы, к которым есть доступ у пользователя
      const { data: userCourses, error } = await supabase
        .from('user_courses')
        .select(`
          course_id,
          access_granted,
          courses (
            title,
            description
          )
        `)
        .eq('user_id', user.id)
        .eq('access_granted', true)

      if (error) {
        coursesContainer.innerHTML = '<p>Ошибка загрузки курсов: ' + error.message + '</p>'
        return
      }

      if (!userCourses || userCourses.length === 0) {
        coursesContainer.innerHTML = '<p>У вас нет доступных курсов.</p>'
        return
      }

      // Для каждого курса получаем уроки и показываем
      for (const uc of userCourses) {
        const course = uc.courses
        const courseDiv = document.createElement('div')
        courseDiv.className = 'course'
        courseDiv.innerHTML = `<h2>${course.title}</h2>`
        coursesContainer.appendChild(courseDiv)

        // Получаем уроки курса
        const { data: lessons, error: lessonsError } = await supabase
          .from('lessons')
          .select('id, title, order_number')
          .eq('course_id', uc.course_id)
          .order('order_number')

        if (lessonsError) {
          courseDiv.innerHTML += `<p>Ошибка загрузки уроков: ${lessonsError.message}</p>`
          continue
        }

        if (!lessons || lessons.length === 0) {
          courseDiv.innerHTML += '<p>Уроки отсутствуют</p>'
          continue
        }

        const ul = document.createElement('ul')
        ul.className = 'lessons'

        lessons.forEach(lesson => {
          const li = document.createElement('li')
          li.textContent = `${lesson.order_number}. ${lesson.title}`
          ul.appendChild(li)
        })

        courseDiv.appendChild(ul)
      }
    }

    loadDashboard()
  </script>
</body>
</html>
