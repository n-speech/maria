<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</title>
  <style>
    body {
      margin: 0;
      background-color: #f9f9f9;
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      height: 100vh;
      padding: 60px 20px 20px;
    }

    .dashboard {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      width: 720px;
      padding: 30px 40px;
      box-sizing: border-box;
    }

    #welcome {
      font-size: 22px;
      font-weight: 600;
      color: #241c15;
      margin-bottom: 10px;
    }

    #courseName {
      font-size: 18px;
      color: #444;
      margin-bottom: 15px;
    }

    .progress-label {
      font-weight: 600;
      color: #333;
      margin-bottom: 6px;
    }

    .progress-bar-container {
      background: lightgrey;
      border-radius: 10px;
      overflow: hidden;
      height: 22px;
      margin-bottom: 8px;
      width: 100%;
    }

    .progress-bar {
      height: 100%;
      background-color: #FFD966;
      width: 0%;
      transition: width 0.5s ease;
    }

    #progressPercent {
      font-weight: 600;
      color: #241c15;
      margin-bottom: 25px;
    }

    .buttons {
      display: flex;
      gap: 15px;
      margin-bottom: 30px;
    }

    .buttons button {
      flex: 1;
    }

    button, .btn-lesson {
      background-color: #FFD966;
      color: #241c15;
      border: none;
      border-radius: 5px;
      padding: 12px 20px;
      font-weight: 700;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      width: 33%;
      box-sizing: border-box;
    }

    .btn-lesson.disabled {
      background-color: #f3f7a3;
      cursor: not-allowed;
      opacity: 0.6;
    }

    #lessons {
      display: none;
      border-top: 1px solid #ddd;
      padding-top: 20px;
    }

    #lessons.active {
      display: block;
    }

    #lessons-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .lesson-card {
      background: #FFFBE8;
      border: 2px solid #F4EDDD;
      border-radius: 8px;
      padding: 20px 25px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      height: 120px;
      line-height: 1.3;
    }

    .lesson-title {
      font-weight: 700;
      font-size: 20px;
      color: #241c15;
      margin: 0 0 4px 0;
    }

    .lesson-grade {
      font-style: italic;
      color: #4e9c5d;
      font-size: 16px;
      margin: 0 0 4px 0;
    }

    .lesson-bottom {
      margin-top: auto;
    }

    /* –ü–ª–∞–Ω—à–µ—Ç */
@media (max-width: 900px) {
  .dashboard {
    width: 100%;
    padding: 20px;
  }

  #welcome, #courseName {
    font-size: 20px;
  }

  .lesson-title {
    font-size: 18px;
  }

  .btn-lesson {
    width: 50%;
  }
}

/* –ú–æ–±–∏–ª—å–Ω—ã–π */
@media (max-width: 600px) {
  body {
    padding: 20px 10px;
  }

  .dashboard {
    padding: 20px;
    border-radius: 0;
    box-shadow: none;
  }

  #welcome, #courseName {
    font-size: 18px;
    text-align: center;
  }

  .lesson-card {
    height: auto;
    padding: 15px;
  }

  .lesson-title {
    font-size: 16px;
  }

  .lesson-grade {
    font-size: 14px;
  }

  .btn-lesson, .buttons button {
    width: 100%;
    font-size: 15px;
    padding: 10px 14px;
  }

  .buttons {
    flex-direction: column;
    gap: 10px;
  }
}

  </style>
</head>
<body>
  <div class="dashboard">
    <div id="welcome">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div id="courseName"></div>

    <div class="progress-label">–ü—Ä–æ–≥—Ä–µ—Å—Å:</div>
    <div class="progress-bar-container">
      <div class="progress-bar" id="progressBar"></div>
    </div>
    <div id="progressPercent"></div>

    <div class="buttons">
      <button id="btnToggleLessons">–ü–æ–∫–∞–∑–∞—Ç—å —É—Ä–æ–∫–∏</button>
      <button id="btnLogout">–í—ã–π—Ç–∏</button>
    </div>

    <div id="lessons">
      <div id="lessons-list"></div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js'

    const supabaseUrl = 'https://eawveeyhkqewfhswcxmy.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVhd3ZlZXloa3Fld2Zoc3djeG15Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NTI5MTYsImV4cCI6MjA2NjMyODkxNn0.-6G5o9dZ2V9cAfqIBIYzFp5PDzs4IehCn_b3YlYot-I'
    const supabase = createClient(supabaseUrl, supabaseKey)

    const welcomeEl = document.getElementById('welcome')
    const courseNameEl = document.getElementById('courseName')
    const progressBarEl = document.getElementById('progressBar')
    const progressPercentEl = document.getElementById('progressPercent')
    const lessonsListEl = document.getElementById('lessons-list')

    async function loadDashboard() {
      const { data: sessionData } = await supabase.auth.getSession()
      const user = sessionData?.session?.user
      if (!user) {
        location.href = 'login.html'
        return
      }

      const { data: profile } = await supabase
        .from('profiles')
        .select('name')
        .eq('id', user.id)
        .single()

      welcomeEl.textContent = `–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${profile?.name || '—É—á–µ–Ω–∏–∫'}!`

      const { data: userCourse } = await supabase
        .from('user_courses')
        .select('progress, course_id, courses(title)')
        .eq('user_id', user.id)
        .eq('access_granted', true)
        .maybeSingle()

      if (!userCourse) {
        courseNameEl.textContent = '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫—É—Ä—Å–æ–≤'
        return
      }

      const { course_id, progress, courses } = userCourse
      courseNameEl.textContent = `–í–∞—à –∫—É—Ä—Å: ${courses?.title}`
      progressBarEl.style.width = `${progress}%`
      progressPercentEl.textContent = `${progress}% –∑–∞–≤–µ—Ä—à–µ–Ω–æ`

      const { data: lessons } = await supabase
        .from('lessons')
        .select('id, title, order_number')
        .eq('course_id', course_id)
        .order('order_number')

      for (const lesson of lessons) {
        const { data: userLesson } = await supabase
          .from('user_lessons')
          .select('grade, access')
          .eq('lesson_id', lesson.id)
          .eq('user_id', user.id)
          .maybeSingle()

        const grade = userLesson?.grade || '‚Äî'
        const isLocked = !userLesson?.access
        const buttonText = isLocked ? '–ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω üîí' : '–ü–µ—Ä–µ–π—Ç–∏ –∫ —É—Ä–æ–∫—É'
        const buttonClass = isLocked ? 'btn-lesson disabled' : 'btn-lesson'

        const lessonCard = document.createElement('div')
        lessonCard.className = 'lesson-card'
        lessonCard.innerHTML = `
          <div class="lesson-title">${lesson.title}</div>
          <div class="lesson-grade">–û—Ü–µ–Ω–∫–∞: ${grade}</div>
          <div class="lesson-bottom">
            <button class="${buttonClass}">${buttonText}</button>
          </div>
        `

        // –ü–µ—Ä–µ—Ö–æ–¥ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø –æ—Ç–∫—Ä—ã—Ç
        if (!isLocked) {
          const button = lessonCard.querySelector('.btn-lesson')
          button.addEventListener('click', () => {
            window.location.href = `lesson.html?id=${lesson.id}`
          })
        }

        lessonsListEl.appendChild(lessonCard)
      }
    }

    document.getElementById('btnToggleLessons').addEventListener('click', () => {
      const lessons = document.getElementById('lessons')
      lessons.classList.toggle('active')
      lessons.style.display = lessons.classList.contains('active') ? 'block' : 'none'
      document.getElementById('btnToggleLessons').textContent =
        lessons.classList.contains('active') ? '–°–∫—Ä—ã—Ç—å —É—Ä–æ–∫–∏' : '–ü–æ–∫–∞–∑–∞—Ç—å —É—Ä–æ–∫–∏'
    })

    document.getElementById('btnLogout').addEventListener('click', async () => {
      await supabase.auth.signOut()
      location.href = 'login.html'
    })

    loadDashboard()
  </script>
</body>
</html>
